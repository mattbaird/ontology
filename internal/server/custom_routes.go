// Custom routes that don't fit the standard CRUD pattern generated by handlergen.
// These operations have unique URL paths and are registered separately.
// Routes here are registered AFTER gen_routes.go, so they override generated
// handlers when the same method+path is used.
package server

import (
	"github.com/go-chi/chi/v5"
	"github.com/matthewbaird/ontology/ent"
	"github.com/matthewbaird/ontology/internal/activity"
	"github.com/matthewbaird/ontology/internal/handler"
)

// RegisterCustomRoutes registers hand-written route mappings for custom
// operations that don't follow the standard CRUD path pattern.
func RegisterCustomRoutes(r chi.Router, client *ent.Client) {
	lh := handler.NewLeaseHandler(client)
	proph := handler.NewPropertyHandler(client)
	ah := handler.NewAccountingHandler(client)

	// Lease search and ledger queries.
	r.Post("/v1/leases/search", lh.SearchLeases)
	r.Get("/v1/leases/{id}/ledger", lh.GetLeaseLedger)
	r.Post("/v1/leases/{id}/charges", lh.PostCharge)
	r.Post("/v1/leases/{id}/credits", lh.ApplyCredit)

	// Command routes — these implement full business logic commands.
	r.Post("/v1/leases/{id}/move-in", lh.MoveInTenant)
	r.Post("/v1/leases/{id}/payments", lh.RecordPayment)

	// Override generated simple transitions with full command implementations.
	r.Post("/v1/leases/{id}/renew", handler.RenewLeaseCommand(client))
	r.Post("/v1/leases/{id}/evict", handler.InitiateEvictionCommand(client))

	// Application command — overrides generated CRUD CreateApplication.
	r.Post("/v1/applications", lh.SubmitApplication)

	// Property onboarding command.
	r.Post("/v1/properties/onboard", proph.OnboardProperty)

	// Reconciliation command.
	r.Post("/v1/reconciliations/{id}/start", ah.StartReconciliation)
}

// RegisterActivityRoutes registers the signal discovery activity endpoints.
// These use a separate activity.Store, not the Ent client.
func RegisterActivityRoutes(r chi.Router, store activity.Store) {
	actH := handler.NewActivityHandler(store)

	r.Get("/v1/activity/entity/{entity_type}/{entity_id}", actH.HandleGetEntityActivity)
	r.Get("/v1/activity/summary/{entity_type}/{entity_id}", actH.HandleGetSignalSummary)
	r.Post("/v1/activity/portfolio", actH.HandleGetPortfolioSignals)
	r.Post("/v1/activity/search", actH.HandleSearchActivity)
}
