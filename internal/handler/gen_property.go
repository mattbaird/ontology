// Code generated by cmd/handlergen from CUE ontology. DO NOT EDIT.
package handler

import (
	"net/http"
	"time"

	"github.com/google/uuid"
	"github.com/matthewbaird/ontology/ent"
	"github.com/matthewbaird/ontology/ent/building"
	"github.com/matthewbaird/ontology/ent/portfolio"
	"github.com/matthewbaird/ontology/ent/property"
	"github.com/matthewbaird/ontology/ent/schema"
	"github.com/matthewbaird/ontology/ent/space"
	"github.com/matthewbaird/ontology/internal/types"
)

// Ensure imports are used.
var (
	_ time.Time
	_ uuid.UUID
	_ = schema.ValidPortfolioTransitions
	_ types.Money
)

// PropertyHandler implements HTTP handlers for PropertyService entities.
type PropertyHandler struct {
	client *ent.Client
}

// NewPropertyHandler creates a new PropertyHandler.
func NewPropertyHandler(client *ent.Client) *PropertyHandler {
	return &PropertyHandler{client: client}
}

// ============================================================================
// Portfolio
// ============================================================================

type createPortfolioRequest struct {
	Name                     string  `json:"name"`
	ManagementType           string  `json:"management_type"`
	Description              *string `json:"description,omitempty"`
	Status                   string  `json:"status"`
	DefaultChartOfAccountsID *string `json:"default_chart_of_accounts_id,omitempty"`
	DefaultBankAccountID     *string `json:"default_bank_account_id,omitempty"`
	OwnerID                  string  `json:"owner_id"`
}

func (h *PropertyHandler) CreatePortfolio(w http.ResponseWriter, r *http.Request) {
	audit, ok := parseAuditContext(w, r)
	if !ok {
		return
	}
	var req createPortfolioRequest
	if err := decodeJSON(r, &req); err != nil {
		writeError(w, http.StatusBadRequest, "INVALID_JSON", err.Error())
		return
	}
	builder := h.client.Portfolio.Create()
	builder.SetName(req.Name)
	builder.SetManagementType(portfolio.ManagementType(req.ManagementType))
	if req.Description != nil {
		builder.SetNillableDescription(req.Description)
	}
	builder.SetStatus(portfolio.Status(req.Status))
	if req.DefaultChartOfAccountsID != nil {
		builder.SetNillableDefaultChartOfAccountsID(req.DefaultChartOfAccountsID)
	}
	if req.DefaultBankAccountID != nil {
		builder.SetNillableDefaultBankAccountID(req.DefaultBankAccountID)
	}
	{
		uid, err := uuid.Parse(req.OwnerID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid owner_id")
			return
		}
		builder.SetOwnerID(uid)
	}
	builder.SetCreatedBy(audit.Actor).SetUpdatedBy(audit.Actor).SetSource(portfolio.Source(audit.Source))
	if audit.CorrelationID != nil {
		builder.SetCorrelationID(*audit.CorrelationID)
	}
	result, err := builder.Save(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusCreated, result)
}

func (h *PropertyHandler) GetPortfolio(w http.ResponseWriter, r *http.Request) {
	id, ok := parseUUID(w, r, "id")
	if !ok {
		return
	}
	result, err := h.client.Portfolio.Get(r.Context(), id)
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, result)
}

func (h *PropertyHandler) ListPortfolios(w http.ResponseWriter, r *http.Request) {
	pg := parsePagination(r)
	items, err := h.client.Portfolio.Query().
		Limit(pg.Limit).Offset(pg.Offset).
		Order(ent.Desc(portfolio.FieldCreatedAt)).
		All(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, items)
}

type updatePortfolioRequest struct {
	Name                     *string `json:"name,omitempty"`
	ManagementType           *string `json:"management_type,omitempty"`
	Description              *string `json:"description,omitempty"`
	Status                   *string `json:"status,omitempty"`
	DefaultChartOfAccountsID *string `json:"default_chart_of_accounts_id,omitempty"`
	DefaultBankAccountID     *string `json:"default_bank_account_id,omitempty"`
	OwnerID                  *string `json:"owner_id,omitempty"`
}

func (h *PropertyHandler) UpdatePortfolio(w http.ResponseWriter, r *http.Request) {
	id, ok := parseUUID(w, r, "id")
	if !ok {
		return
	}
	audit, ok := parseAuditContext(w, r)
	if !ok {
		return
	}
	var req updatePortfolioRequest
	if err := decodeJSON(r, &req); err != nil {
		writeError(w, http.StatusBadRequest, "INVALID_JSON", err.Error())
		return
	}
	builder := h.client.Portfolio.UpdateOneID(id)
	if req.Name != nil {
		builder.SetName(*req.Name)
	}
	if req.ManagementType != nil {
		builder.SetManagementType(portfolio.ManagementType(*req.ManagementType))
	}
	if req.Description != nil {
		builder.SetNillableDescription(req.Description)
	}
	if req.Status != nil {
		builder.SetStatus(portfolio.Status(*req.Status))
	}
	if req.DefaultChartOfAccountsID != nil {
		builder.SetNillableDefaultChartOfAccountsID(req.DefaultChartOfAccountsID)
	}
	if req.DefaultBankAccountID != nil {
		builder.SetNillableDefaultBankAccountID(req.DefaultBankAccountID)
	}
	if req.OwnerID != nil {
		uid, err := uuid.Parse(*req.OwnerID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid owner_id")
			return
		}
		builder.SetOwnerID(uid)
	}
	builder.SetUpdatedBy(audit.Actor).SetSource(portfolio.Source(audit.Source))
	if audit.CorrelationID != nil {
		builder.SetCorrelationID(*audit.CorrelationID)
	}
	result, err := builder.Save(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, result)
}

func (h *PropertyHandler) transitionPortfolio(w http.ResponseWriter, r *http.Request, targetStatus string, applyExtra func(*ent.PortfolioUpdateOne)) {
	id, ok := parseUUID(w, r, "id")
	if !ok {
		return
	}
	audit, ok := parseAuditContext(w, r)
	if !ok {
		return
	}
	current, err := h.client.Portfolio.Get(r.Context(), id)
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	if err := ValidateTransition(schema.ValidPortfolioTransitions, string(current.Status), targetStatus); err != nil {
		writeError(w, http.StatusConflict, "INVALID_TRANSITION", err.Error())
		return
	}
	builder := h.client.Portfolio.UpdateOneID(id).
		SetStatus(portfolio.Status(targetStatus)).
		SetUpdatedBy(audit.Actor).
		SetSource(portfolio.Source(audit.Source))
	if audit.CorrelationID != nil {
		builder.SetCorrelationID(*audit.CorrelationID)
	}
	if applyExtra != nil {
		applyExtra(builder)
	}
	updated, err := builder.Save(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, updated)
}

func (h *PropertyHandler) ActivatePortfolio(w http.ResponseWriter, r *http.Request) {
	h.transitionPortfolio(w, r, "active", nil)
}

// ============================================================================
// Property
// ============================================================================

type createPropertyRequest struct {
	Name                   string        `json:"name"`
	Address                types.Address `json:"address"`
	PropertyType           string        `json:"property_type"`
	Status                 string        `json:"status"`
	YearBuilt              int           `json:"year_built"`
	TotalSquareFootage     float64       `json:"total_square_footage"`
	TotalSpaces            int           `json:"total_spaces"`
	LotSizeSqft            *float64      `json:"lot_size_sqft,omitempty"`
	Stories                *int          `json:"stories,omitempty"`
	ParkingSpaces          *int          `json:"parking_spaces,omitempty"`
	JurisdictionID         *string       `json:"jurisdiction_id,omitempty"`
	RentControlled         bool          `json:"rent_controlled"`
	CompliancePrograms     []string      `json:"compliance_programs,omitempty"`
	RequiresLeadDisclosure bool          `json:"requires_lead_disclosure"`
	ChartOfAccountsID      *string       `json:"chart_of_accounts_id,omitempty"`
	InsurancePolicyNumber  *string       `json:"insurance_policy_number,omitempty"`
	InsuranceExpiry        *time.Time    `json:"insurance_expiry,omitempty"`
	PortfolioID            string        `json:"portfolio_id"`
	BankAccountID          *string       `json:"bank_account_id,omitempty"`
}

func (h *PropertyHandler) CreateProperty(w http.ResponseWriter, r *http.Request) {
	audit, ok := parseAuditContext(w, r)
	if !ok {
		return
	}
	var req createPropertyRequest
	if err := decodeJSON(r, &req); err != nil {
		writeError(w, http.StatusBadRequest, "INVALID_JSON", err.Error())
		return
	}
	builder := h.client.Property.Create()
	builder.SetName(req.Name)
	builder.SetAddress(&req.Address)
	builder.SetPropertyType(property.PropertyType(req.PropertyType))
	builder.SetStatus(property.Status(req.Status))
	builder.SetYearBuilt(req.YearBuilt)
	builder.SetTotalSquareFootage(req.TotalSquareFootage)
	builder.SetTotalSpaces(req.TotalSpaces)
	if req.LotSizeSqft != nil {
		builder.SetNillableLotSizeSqft(req.LotSizeSqft)
	}
	if req.Stories != nil {
		builder.SetNillableStories(req.Stories)
	}
	if req.ParkingSpaces != nil {
		builder.SetNillableParkingSpaces(req.ParkingSpaces)
	}
	if req.JurisdictionID != nil {
		builder.SetNillableJurisdictionID(req.JurisdictionID)
	}
	builder.SetRentControlled(req.RentControlled)
	if len(req.CompliancePrograms) > 0 {
		builder.SetCompliancePrograms(req.CompliancePrograms)
	}
	builder.SetRequiresLeadDisclosure(req.RequiresLeadDisclosure)
	if req.ChartOfAccountsID != nil {
		builder.SetNillableChartOfAccountsID(req.ChartOfAccountsID)
	}
	if req.InsurancePolicyNumber != nil {
		builder.SetNillableInsurancePolicyNumber(req.InsurancePolicyNumber)
	}
	if req.InsuranceExpiry != nil {
		builder.SetNillableInsuranceExpiry(req.InsuranceExpiry)
	}
	{
		uid, err := uuid.Parse(req.PortfolioID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid portfolio_id")
			return
		}
		builder.SetPortfolioID(uid)
	}
	if req.BankAccountID != nil {
		uid, err := uuid.Parse(*req.BankAccountID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid bank_account_id")
			return
		}
		builder.SetBankAccountID(uid)
	}
	builder.SetCreatedBy(audit.Actor).SetUpdatedBy(audit.Actor).SetSource(property.Source(audit.Source))
	if audit.CorrelationID != nil {
		builder.SetCorrelationID(*audit.CorrelationID)
	}
	result, err := builder.Save(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusCreated, result)
}

func (h *PropertyHandler) GetProperty(w http.ResponseWriter, r *http.Request) {
	id, ok := parseUUID(w, r, "id")
	if !ok {
		return
	}
	result, err := h.client.Property.Get(r.Context(), id)
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, result)
}

func (h *PropertyHandler) ListProperties(w http.ResponseWriter, r *http.Request) {
	pg := parsePagination(r)
	items, err := h.client.Property.Query().
		Limit(pg.Limit).Offset(pg.Offset).
		Order(ent.Desc(property.FieldCreatedAt)).
		All(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, items)
}

type updatePropertyRequest struct {
	Name                   *string        `json:"name,omitempty"`
	Address                *types.Address `json:"address,omitempty"`
	PropertyType           *string        `json:"property_type,omitempty"`
	Status                 *string        `json:"status,omitempty"`
	YearBuilt              *int           `json:"year_built,omitempty"`
	TotalSquareFootage     *float64       `json:"total_square_footage,omitempty"`
	TotalSpaces            *int           `json:"total_spaces,omitempty"`
	LotSizeSqft            *float64       `json:"lot_size_sqft,omitempty"`
	Stories                *int           `json:"stories,omitempty"`
	ParkingSpaces          *int           `json:"parking_spaces,omitempty"`
	JurisdictionID         *string        `json:"jurisdiction_id,omitempty"`
	RentControlled         *bool          `json:"rent_controlled,omitempty"`
	CompliancePrograms     []string       `json:"compliance_programs,omitempty"`
	RequiresLeadDisclosure *bool          `json:"requires_lead_disclosure,omitempty"`
	ChartOfAccountsID      *string        `json:"chart_of_accounts_id,omitempty"`
	InsurancePolicyNumber  *string        `json:"insurance_policy_number,omitempty"`
	InsuranceExpiry        *time.Time     `json:"insurance_expiry,omitempty"`
	PortfolioID            *string        `json:"portfolio_id,omitempty"`
	BankAccountID          *string        `json:"bank_account_id,omitempty"`
}

func (h *PropertyHandler) UpdateProperty(w http.ResponseWriter, r *http.Request) {
	id, ok := parseUUID(w, r, "id")
	if !ok {
		return
	}
	audit, ok := parseAuditContext(w, r)
	if !ok {
		return
	}
	var req updatePropertyRequest
	if err := decodeJSON(r, &req); err != nil {
		writeError(w, http.StatusBadRequest, "INVALID_JSON", err.Error())
		return
	}
	builder := h.client.Property.UpdateOneID(id)
	if req.Name != nil {
		builder.SetName(*req.Name)
	}
	if req.Address != nil {
		builder.SetAddress(req.Address)
	}
	if req.PropertyType != nil {
		builder.SetPropertyType(property.PropertyType(*req.PropertyType))
	}
	if req.Status != nil {
		builder.SetStatus(property.Status(*req.Status))
	}
	if req.YearBuilt != nil {
		builder.SetYearBuilt(*req.YearBuilt)
	}
	if req.TotalSquareFootage != nil {
		builder.SetTotalSquareFootage(*req.TotalSquareFootage)
	}
	if req.TotalSpaces != nil {
		builder.SetTotalSpaces(*req.TotalSpaces)
	}
	if req.LotSizeSqft != nil {
		builder.SetNillableLotSizeSqft(req.LotSizeSqft)
	}
	if req.Stories != nil {
		builder.SetNillableStories(req.Stories)
	}
	if req.ParkingSpaces != nil {
		builder.SetNillableParkingSpaces(req.ParkingSpaces)
	}
	if req.JurisdictionID != nil {
		builder.SetNillableJurisdictionID(req.JurisdictionID)
	}
	if req.RentControlled != nil {
		builder.SetRentControlled(*req.RentControlled)
	}
	if req.CompliancePrograms != nil {
		builder.SetCompliancePrograms(req.CompliancePrograms)
	}
	if req.RequiresLeadDisclosure != nil {
		builder.SetRequiresLeadDisclosure(*req.RequiresLeadDisclosure)
	}
	if req.ChartOfAccountsID != nil {
		builder.SetNillableChartOfAccountsID(req.ChartOfAccountsID)
	}
	if req.InsurancePolicyNumber != nil {
		builder.SetNillableInsurancePolicyNumber(req.InsurancePolicyNumber)
	}
	if req.InsuranceExpiry != nil {
		builder.SetNillableInsuranceExpiry(req.InsuranceExpiry)
	}
	if req.PortfolioID != nil {
		uid, err := uuid.Parse(*req.PortfolioID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid portfolio_id")
			return
		}
		builder.SetPortfolioID(uid)
	}
	if req.BankAccountID != nil {
		uid, err := uuid.Parse(*req.BankAccountID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid bank_account_id")
			return
		}
		builder.SetBankAccountID(uid)
	}
	builder.SetUpdatedBy(audit.Actor).SetSource(property.Source(audit.Source))
	if audit.CorrelationID != nil {
		builder.SetCorrelationID(*audit.CorrelationID)
	}
	result, err := builder.Save(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, result)
}

func (h *PropertyHandler) transitionProperty(w http.ResponseWriter, r *http.Request, targetStatus string, applyExtra func(*ent.PropertyUpdateOne)) {
	id, ok := parseUUID(w, r, "id")
	if !ok {
		return
	}
	audit, ok := parseAuditContext(w, r)
	if !ok {
		return
	}
	current, err := h.client.Property.Get(r.Context(), id)
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	if err := ValidateTransition(schema.ValidPropertyTransitions, string(current.Status), targetStatus); err != nil {
		writeError(w, http.StatusConflict, "INVALID_TRANSITION", err.Error())
		return
	}
	builder := h.client.Property.UpdateOneID(id).
		SetStatus(property.Status(targetStatus)).
		SetUpdatedBy(audit.Actor).
		SetSource(property.Source(audit.Source))
	if audit.CorrelationID != nil {
		builder.SetCorrelationID(*audit.CorrelationID)
	}
	if applyExtra != nil {
		applyExtra(builder)
	}
	updated, err := builder.Save(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, updated)
}

func (h *PropertyHandler) ActivateProperty(w http.ResponseWriter, r *http.Request) {
	h.transitionProperty(w, r, "active", nil)
}

// ============================================================================
// Building
// ============================================================================

type createBuildingRequest struct {
	Name                       string         `json:"name"`
	BuildingType               string         `json:"building_type"`
	Address                    *types.Address `json:"address,omitempty"`
	Description                *string        `json:"description,omitempty"`
	Status                     string         `json:"status"`
	Floors                     *int           `json:"floors,omitempty"`
	YearBuilt                  *int           `json:"year_built,omitempty"`
	TotalSquareFootage         *float64       `json:"total_square_footage,omitempty"`
	TotalRentableSquareFootage *float64       `json:"total_rentable_square_footage,omitempty"`
	PropertyID                 string         `json:"property_id"`
}

func (h *PropertyHandler) CreateBuilding(w http.ResponseWriter, r *http.Request) {
	audit, ok := parseAuditContext(w, r)
	if !ok {
		return
	}
	var req createBuildingRequest
	if err := decodeJSON(r, &req); err != nil {
		writeError(w, http.StatusBadRequest, "INVALID_JSON", err.Error())
		return
	}
	builder := h.client.Building.Create()
	builder.SetName(req.Name)
	builder.SetBuildingType(building.BuildingType(req.BuildingType))
	if req.Address != nil {
		builder.SetAddress(req.Address)
	}
	if req.Description != nil {
		builder.SetNillableDescription(req.Description)
	}
	builder.SetStatus(building.Status(req.Status))
	if req.Floors != nil {
		builder.SetNillableFloors(req.Floors)
	}
	if req.YearBuilt != nil {
		builder.SetNillableYearBuilt(req.YearBuilt)
	}
	if req.TotalSquareFootage != nil {
		builder.SetNillableTotalSquareFootage(req.TotalSquareFootage)
	}
	if req.TotalRentableSquareFootage != nil {
		builder.SetNillableTotalRentableSquareFootage(req.TotalRentableSquareFootage)
	}
	{
		uid, err := uuid.Parse(req.PropertyID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid property_id")
			return
		}
		builder.SetPropertyID(uid)
	}
	builder.SetCreatedBy(audit.Actor).SetUpdatedBy(audit.Actor).SetSource(building.Source(audit.Source))
	if audit.CorrelationID != nil {
		builder.SetCorrelationID(*audit.CorrelationID)
	}
	result, err := builder.Save(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusCreated, result)
}

func (h *PropertyHandler) GetBuilding(w http.ResponseWriter, r *http.Request) {
	id, ok := parseUUID(w, r, "id")
	if !ok {
		return
	}
	result, err := h.client.Building.Get(r.Context(), id)
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, result)
}

func (h *PropertyHandler) ListBuildings(w http.ResponseWriter, r *http.Request) {
	pg := parsePagination(r)
	items, err := h.client.Building.Query().
		Limit(pg.Limit).Offset(pg.Offset).
		Order(ent.Desc(building.FieldCreatedAt)).
		All(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, items)
}

type updateBuildingRequest struct {
	Name                       *string        `json:"name,omitempty"`
	BuildingType               *string        `json:"building_type,omitempty"`
	Address                    *types.Address `json:"address,omitempty"`
	Description                *string        `json:"description,omitempty"`
	Status                     *string        `json:"status,omitempty"`
	Floors                     *int           `json:"floors,omitempty"`
	YearBuilt                  *int           `json:"year_built,omitempty"`
	TotalSquareFootage         *float64       `json:"total_square_footage,omitempty"`
	TotalRentableSquareFootage *float64       `json:"total_rentable_square_footage,omitempty"`
	PropertyID                 *string        `json:"property_id,omitempty"`
}

func (h *PropertyHandler) UpdateBuilding(w http.ResponseWriter, r *http.Request) {
	id, ok := parseUUID(w, r, "id")
	if !ok {
		return
	}
	audit, ok := parseAuditContext(w, r)
	if !ok {
		return
	}
	var req updateBuildingRequest
	if err := decodeJSON(r, &req); err != nil {
		writeError(w, http.StatusBadRequest, "INVALID_JSON", err.Error())
		return
	}
	builder := h.client.Building.UpdateOneID(id)
	if req.Name != nil {
		builder.SetName(*req.Name)
	}
	if req.BuildingType != nil {
		builder.SetBuildingType(building.BuildingType(*req.BuildingType))
	}
	if req.Address != nil {
		builder.SetAddress(req.Address)
	}
	if req.Description != nil {
		builder.SetNillableDescription(req.Description)
	}
	if req.Status != nil {
		builder.SetStatus(building.Status(*req.Status))
	}
	if req.Floors != nil {
		builder.SetNillableFloors(req.Floors)
	}
	if req.YearBuilt != nil {
		builder.SetNillableYearBuilt(req.YearBuilt)
	}
	if req.TotalSquareFootage != nil {
		builder.SetNillableTotalSquareFootage(req.TotalSquareFootage)
	}
	if req.TotalRentableSquareFootage != nil {
		builder.SetNillableTotalRentableSquareFootage(req.TotalRentableSquareFootage)
	}
	if req.PropertyID != nil {
		uid, err := uuid.Parse(*req.PropertyID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid property_id")
			return
		}
		builder.SetPropertyID(uid)
	}
	builder.SetUpdatedBy(audit.Actor).SetSource(building.Source(audit.Source))
	if audit.CorrelationID != nil {
		builder.SetCorrelationID(*audit.CorrelationID)
	}
	result, err := builder.Save(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, result)
}

func (h *PropertyHandler) transitionBuilding(w http.ResponseWriter, r *http.Request, targetStatus string, applyExtra func(*ent.BuildingUpdateOne)) {
	id, ok := parseUUID(w, r, "id")
	if !ok {
		return
	}
	audit, ok := parseAuditContext(w, r)
	if !ok {
		return
	}
	current, err := h.client.Building.Get(r.Context(), id)
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	if err := ValidateTransition(schema.ValidBuildingTransitions, string(current.Status), targetStatus); err != nil {
		writeError(w, http.StatusConflict, "INVALID_TRANSITION", err.Error())
		return
	}
	builder := h.client.Building.UpdateOneID(id).
		SetStatus(building.Status(targetStatus)).
		SetUpdatedBy(audit.Actor).
		SetSource(building.Source(audit.Source))
	if audit.CorrelationID != nil {
		builder.SetCorrelationID(*audit.CorrelationID)
	}
	if applyExtra != nil {
		applyExtra(builder)
	}
	updated, err := builder.Save(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, updated)
}

func (h *PropertyHandler) DeactivateBuilding(w http.ResponseWriter, r *http.Request) {
	h.transitionBuilding(w, r, "inactive", nil)
}

func (h *PropertyHandler) StartBuildingRenovation(w http.ResponseWriter, r *http.Request) {
	h.transitionBuilding(w, r, "under_renovation", nil)
}

func (h *PropertyHandler) ActivateBuilding(w http.ResponseWriter, r *http.Request) {
	h.transitionBuilding(w, r, "active", nil)
}

// ============================================================================
// Space
// ============================================================================

type createSpaceRequest struct {
	SpaceNumber               string   `json:"space_number"`
	SpaceType                 string   `json:"space_type"`
	Status                    string   `json:"status"`
	Leasable                  bool     `json:"leasable"`
	SharedWithParent          bool     `json:"shared_with_parent"`
	SquareFootage             float64  `json:"square_footage"`
	Bedrooms                  *int     `json:"bedrooms,omitempty"`
	Bathrooms                 *float64 `json:"bathrooms,omitempty"`
	Floor                     *int     `json:"floor,omitempty"`
	Amenities                 []string `json:"amenities,omitempty"`
	FloorPlan                 *string  `json:"floor_plan,omitempty"`
	AdaAccessible             bool     `json:"ada_accessible"`
	PetFriendly               bool     `json:"pet_friendly"`
	Furnished                 bool     `json:"furnished"`
	SpecializedInfrastructure []string `json:"specialized_infrastructure,omitempty"`
	MarketRentAmountCents     *int64   `json:"market_rent_amount_cents,omitempty"`
	MarketRentCurrency        *string  `json:"market_rent_currency,omitempty"`
	AmiRestriction            *int     `json:"ami_restriction,omitempty"`
	ActiveLeaseID             *string  `json:"active_lease_id,omitempty"`
	PropertyID                string   `json:"property_id"`
	BuildingID                *string  `json:"building_id,omitempty"`
	ParentSpaceID             *string  `json:"parent_space_id,omitempty"`
}

func (h *PropertyHandler) CreateSpace(w http.ResponseWriter, r *http.Request) {
	audit, ok := parseAuditContext(w, r)
	if !ok {
		return
	}
	var req createSpaceRequest
	if err := decodeJSON(r, &req); err != nil {
		writeError(w, http.StatusBadRequest, "INVALID_JSON", err.Error())
		return
	}
	builder := h.client.Space.Create()
	builder.SetSpaceNumber(req.SpaceNumber)
	builder.SetSpaceType(space.SpaceType(req.SpaceType))
	builder.SetStatus(space.Status(req.Status))
	builder.SetLeasable(req.Leasable)
	builder.SetSharedWithParent(req.SharedWithParent)
	builder.SetSquareFootage(req.SquareFootage)
	if req.Bedrooms != nil {
		builder.SetNillableBedrooms(req.Bedrooms)
	}
	if req.Bathrooms != nil {
		builder.SetNillableBathrooms(req.Bathrooms)
	}
	if req.Floor != nil {
		builder.SetNillableFloor(req.Floor)
	}
	if len(req.Amenities) > 0 {
		builder.SetAmenities(req.Amenities)
	}
	if req.FloorPlan != nil {
		builder.SetNillableFloorPlan(req.FloorPlan)
	}
	builder.SetAdaAccessible(req.AdaAccessible)
	builder.SetPetFriendly(req.PetFriendly)
	builder.SetFurnished(req.Furnished)
	if len(req.SpecializedInfrastructure) > 0 {
		builder.SetSpecializedInfrastructure(req.SpecializedInfrastructure)
	}
	if req.MarketRentAmountCents != nil {
		builder.SetNillableMarketRentAmountCents(req.MarketRentAmountCents)
	}
	if req.MarketRentCurrency != nil {
		builder.SetNillableMarketRentCurrency(req.MarketRentCurrency)
	}
	if req.AmiRestriction != nil {
		builder.SetNillableAmiRestriction(req.AmiRestriction)
	}
	if req.ActiveLeaseID != nil {
		builder.SetNillableActiveLeaseID(req.ActiveLeaseID)
	}
	{
		uid, err := uuid.Parse(req.PropertyID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid property_id")
			return
		}
		builder.SetPropertyID(uid)
	}
	if req.BuildingID != nil {
		uid, err := uuid.Parse(*req.BuildingID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid building_id")
			return
		}
		builder.SetBuildingID(uid)
	}
	if req.ParentSpaceID != nil {
		uid, err := uuid.Parse(*req.ParentSpaceID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid parent_space_id")
			return
		}
		builder.SetParentSpaceID(uid)
	}
	builder.SetCreatedBy(audit.Actor).SetUpdatedBy(audit.Actor).SetSource(space.Source(audit.Source))
	if audit.CorrelationID != nil {
		builder.SetCorrelationID(*audit.CorrelationID)
	}
	result, err := builder.Save(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusCreated, result)
}

func (h *PropertyHandler) GetSpace(w http.ResponseWriter, r *http.Request) {
	id, ok := parseUUID(w, r, "id")
	if !ok {
		return
	}
	result, err := h.client.Space.Get(r.Context(), id)
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, result)
}

func (h *PropertyHandler) ListSpaces(w http.ResponseWriter, r *http.Request) {
	pg := parsePagination(r)
	items, err := h.client.Space.Query().
		Limit(pg.Limit).Offset(pg.Offset).
		Order(ent.Desc(space.FieldCreatedAt)).
		All(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, items)
}

type updateSpaceRequest struct {
	SpaceNumber               *string  `json:"space_number,omitempty"`
	SpaceType                 *string  `json:"space_type,omitempty"`
	Status                    *string  `json:"status,omitempty"`
	Leasable                  *bool    `json:"leasable,omitempty"`
	SharedWithParent          *bool    `json:"shared_with_parent,omitempty"`
	SquareFootage             *float64 `json:"square_footage,omitempty"`
	Bedrooms                  *int     `json:"bedrooms,omitempty"`
	Bathrooms                 *float64 `json:"bathrooms,omitempty"`
	Floor                     *int     `json:"floor,omitempty"`
	Amenities                 []string `json:"amenities,omitempty"`
	FloorPlan                 *string  `json:"floor_plan,omitempty"`
	AdaAccessible             *bool    `json:"ada_accessible,omitempty"`
	PetFriendly               *bool    `json:"pet_friendly,omitempty"`
	Furnished                 *bool    `json:"furnished,omitempty"`
	SpecializedInfrastructure []string `json:"specialized_infrastructure,omitempty"`
	MarketRentAmountCents     *int64   `json:"market_rent_amount_cents,omitempty"`
	MarketRentCurrency        *string  `json:"market_rent_currency,omitempty"`
	AmiRestriction            *int     `json:"ami_restriction,omitempty"`
	ActiveLeaseID             *string  `json:"active_lease_id,omitempty"`
	PropertyID                *string  `json:"property_id,omitempty"`
	BuildingID                *string  `json:"building_id,omitempty"`
	ParentSpaceID             *string  `json:"parent_space_id,omitempty"`
}

func (h *PropertyHandler) UpdateSpace(w http.ResponseWriter, r *http.Request) {
	id, ok := parseUUID(w, r, "id")
	if !ok {
		return
	}
	audit, ok := parseAuditContext(w, r)
	if !ok {
		return
	}
	var req updateSpaceRequest
	if err := decodeJSON(r, &req); err != nil {
		writeError(w, http.StatusBadRequest, "INVALID_JSON", err.Error())
		return
	}
	builder := h.client.Space.UpdateOneID(id)
	if req.SpaceNumber != nil {
		builder.SetSpaceNumber(*req.SpaceNumber)
	}
	if req.SpaceType != nil {
		builder.SetSpaceType(space.SpaceType(*req.SpaceType))
	}
	if req.Status != nil {
		builder.SetStatus(space.Status(*req.Status))
	}
	if req.Leasable != nil {
		builder.SetLeasable(*req.Leasable)
	}
	if req.SharedWithParent != nil {
		builder.SetSharedWithParent(*req.SharedWithParent)
	}
	if req.SquareFootage != nil {
		builder.SetSquareFootage(*req.SquareFootage)
	}
	if req.Bedrooms != nil {
		builder.SetNillableBedrooms(req.Bedrooms)
	}
	if req.Bathrooms != nil {
		builder.SetNillableBathrooms(req.Bathrooms)
	}
	if req.Floor != nil {
		builder.SetNillableFloor(req.Floor)
	}
	if req.Amenities != nil {
		builder.SetAmenities(req.Amenities)
	}
	if req.FloorPlan != nil {
		builder.SetNillableFloorPlan(req.FloorPlan)
	}
	if req.AdaAccessible != nil {
		builder.SetAdaAccessible(*req.AdaAccessible)
	}
	if req.PetFriendly != nil {
		builder.SetPetFriendly(*req.PetFriendly)
	}
	if req.Furnished != nil {
		builder.SetFurnished(*req.Furnished)
	}
	if req.SpecializedInfrastructure != nil {
		builder.SetSpecializedInfrastructure(req.SpecializedInfrastructure)
	}
	if req.MarketRentAmountCents != nil {
		builder.SetMarketRentAmountCents(*req.MarketRentAmountCents)
	}
	if req.MarketRentCurrency != nil {
		builder.SetMarketRentCurrency(*req.MarketRentCurrency)
	}
	if req.AmiRestriction != nil {
		builder.SetNillableAmiRestriction(req.AmiRestriction)
	}
	if req.ActiveLeaseID != nil {
		builder.SetNillableActiveLeaseID(req.ActiveLeaseID)
	}
	if req.PropertyID != nil {
		uid, err := uuid.Parse(*req.PropertyID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid property_id")
			return
		}
		builder.SetPropertyID(uid)
	}
	if req.BuildingID != nil {
		uid, err := uuid.Parse(*req.BuildingID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid building_id")
			return
		}
		builder.SetBuildingID(uid)
	}
	if req.ParentSpaceID != nil {
		uid, err := uuid.Parse(*req.ParentSpaceID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid parent_space_id")
			return
		}
		builder.SetParentSpaceID(uid)
	}
	builder.SetUpdatedBy(audit.Actor).SetSource(space.Source(audit.Source))
	if audit.CorrelationID != nil {
		builder.SetCorrelationID(*audit.CorrelationID)
	}
	result, err := builder.Save(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, result)
}

func (h *PropertyHandler) transitionSpace(w http.ResponseWriter, r *http.Request, targetStatus string, applyExtra func(*ent.SpaceUpdateOne)) {
	id, ok := parseUUID(w, r, "id")
	if !ok {
		return
	}
	audit, ok := parseAuditContext(w, r)
	if !ok {
		return
	}
	current, err := h.client.Space.Get(r.Context(), id)
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	if err := ValidateTransition(schema.ValidSpaceTransitions, string(current.Status), targetStatus); err != nil {
		writeError(w, http.StatusConflict, "INVALID_TRANSITION", err.Error())
		return
	}
	builder := h.client.Space.UpdateOneID(id).
		SetStatus(space.Status(targetStatus)).
		SetUpdatedBy(audit.Actor).
		SetSource(space.Source(audit.Source))
	if audit.CorrelationID != nil {
		builder.SetCorrelationID(*audit.CorrelationID)
	}
	if applyExtra != nil {
		applyExtra(builder)
	}
	updated, err := builder.Save(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, updated)
}

func (h *PropertyHandler) OccupySpace(w http.ResponseWriter, r *http.Request) {
	h.transitionSpace(w, r, "occupied", nil)
}

func (h *PropertyHandler) RecordSpaceNotice(w http.ResponseWriter, r *http.Request) {
	h.transitionSpace(w, r, "notice_given", nil)
}

func (h *PropertyHandler) RescindSpaceNotice(w http.ResponseWriter, r *http.Request) {
	h.transitionSpace(w, r, "occupied", nil)
}

func (h *PropertyHandler) StartMakeReady(w http.ResponseWriter, r *http.Request) {
	h.transitionSpace(w, r, "make_ready", nil)
}

func (h *PropertyHandler) MarkSpaceVacant(w http.ResponseWriter, r *http.Request) {
	h.transitionSpace(w, r, "vacant", nil)
}

func (h *PropertyHandler) MarkSpaceDown(w http.ResponseWriter, r *http.Request) {
	h.transitionSpace(w, r, "down", nil)
}

func (h *PropertyHandler) MarkSpaceModel(w http.ResponseWriter, r *http.Request) {
	h.transitionSpace(w, r, "model", nil)
}

func (h *PropertyHandler) ReserveSpace(w http.ResponseWriter, r *http.Request) {
	h.transitionSpace(w, r, "reserved", nil)
}
