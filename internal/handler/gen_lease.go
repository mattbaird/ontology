// Code generated by cmd/handlergen from CUE ontology. DO NOT EDIT.
package handler

import (
	"net/http"
	"time"

	"github.com/google/uuid"
	"github.com/matthewbaird/ontology/ent"
	"github.com/matthewbaird/ontology/ent/application"
	"github.com/matthewbaird/ontology/ent/lease"
	"github.com/matthewbaird/ontology/ent/leasespace"
	"github.com/matthewbaird/ontology/ent/schema"
	"github.com/matthewbaird/ontology/internal/types"
)

// Ensure imports are used.
var (
	_ time.Time
	_ uuid.UUID
	_ = schema.ValidLeaseTransitions
	_ types.Money
)

// LeaseHandler implements HTTP handlers for LeaseService entities.
type LeaseHandler struct {
	client *ent.Client
}

// NewLeaseHandler creates a new LeaseHandler.
func NewLeaseHandler(client *ent.Client) *LeaseHandler {
	return &LeaseHandler{client: client}
}

// ============================================================================
// Lease
// ============================================================================

type createLeaseRequest struct {
	PropertyID                 string                    `json:"property_id"`
	TenantRoleIds              []string                  `json:"tenant_role_ids"`
	GuarantorRoleIds           []string                  `json:"guarantor_role_ids,omitempty"`
	LeaseType                  string                    `json:"lease_type"`
	Status                     string                    `json:"status"`
	Description                *string                   `json:"description,omitempty"`
	LiabilityType              string                    `json:"liability_type"`
	Term                       types.DateRange           `json:"term"`
	LeaseCommencementDate      *time.Time                `json:"lease_commencement_date,omitempty"`
	RentCommencementDate       *time.Time                `json:"rent_commencement_date,omitempty"`
	BaseRentAmountCents        int64                     `json:"base_rent_amount_cents"`
	BaseRentCurrency           string                    `json:"base_rent_currency,omitempty"`
	SecurityDepositAmountCents int64                     `json:"security_deposit_amount_cents"`
	SecurityDepositCurrency    string                    `json:"security_deposit_currency,omitempty"`
	RentSchedule               []types.RentScheduleEntry `json:"rent_schedule,omitempty"`
	RecurringCharges           []types.RecurringCharge   `json:"recurring_charges,omitempty"`
	LateFeePolicy              *types.LateFeePolicy      `json:"late_fee_policy,omitempty"`
	CamTerms                   *types.CAMTerms           `json:"cam_terms,omitempty"`
	TenantImprovement          *types.TenantImprovement  `json:"tenant_improvement,omitempty"`
	RenewalOptions             []types.RenewalOption     `json:"renewal_options,omitempty"`
	UsageCharges               []types.UsageBasedCharge  `json:"usage_charges,omitempty"`
	PercentageRent             *types.PercentageRent     `json:"percentage_rent,omitempty"`
	ExpansionRights            []types.ExpansionRight    `json:"expansion_rights,omitempty"`
	ContractionRights          []types.ContractionRight  `json:"contraction_rights,omitempty"`
	Subsidy                    *types.SubsidyTerms       `json:"subsidy,omitempty"`
	MoveInDate                 *time.Time                `json:"move_in_date,omitempty"`
	MoveOutDate                *time.Time                `json:"move_out_date,omitempty"`
	NoticeDate                 *time.Time                `json:"notice_date,omitempty"`
	NoticeRequiredDays         int                       `json:"notice_required_days"`
	CheckInTime                *string                   `json:"check_in_time,omitempty"`
	CheckOutTime               *string                   `json:"check_out_time,omitempty"`
	CleaningFeeAmountCents     *int64                    `json:"cleaning_fee_amount_cents,omitempty"`
	CleaningFeeCurrency        *string                   `json:"cleaning_fee_currency,omitempty"`
	PlatformBookingID          *string                   `json:"platform_booking_id,omitempty"`
	MembershipTier             *string                   `json:"membership_tier,omitempty"`
	IsSublease                 bool                      `json:"is_sublease"`
	SubleaseBilling            string                    `json:"sublease_billing"`
	SigningMethod              *string                   `json:"signing_method,omitempty"`
	SignedAt                   *time.Time                `json:"signed_at,omitempty"`
	DocumentID                 *string                   `json:"document_id,omitempty"`
	ParentLeaseID              *string                   `json:"parent_lease_id,omitempty"`
}

func (h *LeaseHandler) CreateLease(w http.ResponseWriter, r *http.Request) {
	audit, ok := parseAuditContext(w, r)
	if !ok {
		return
	}
	var req createLeaseRequest
	if err := decodeJSON(r, &req); err != nil {
		writeError(w, http.StatusBadRequest, "INVALID_JSON", err.Error())
		return
	}
	builder := h.client.Lease.Create()
	builder.SetPropertyID(req.PropertyID)
	builder.SetTenantRoleIds(req.TenantRoleIds)
	if len(req.GuarantorRoleIds) > 0 {
		builder.SetGuarantorRoleIds(req.GuarantorRoleIds)
	}
	builder.SetLeaseType(lease.LeaseType(req.LeaseType))
	builder.SetStatus(lease.Status(req.Status))
	if req.Description != nil {
		builder.SetNillableDescription(req.Description)
	}
	if req.LiabilityType != "" {
		builder.SetLiabilityType(lease.LiabilityType(req.LiabilityType))
	}
	builder.SetTerm(&req.Term)
	if req.LeaseCommencementDate != nil {
		builder.SetNillableLeaseCommencementDate(req.LeaseCommencementDate)
	}
	if req.RentCommencementDate != nil {
		builder.SetNillableRentCommencementDate(req.RentCommencementDate)
	}
	builder.SetBaseRentAmountCents(req.BaseRentAmountCents)
	if req.BaseRentCurrency != "" {
		builder.SetBaseRentCurrency(req.BaseRentCurrency)
	}
	builder.SetSecurityDepositAmountCents(req.SecurityDepositAmountCents)
	if req.SecurityDepositCurrency != "" {
		builder.SetSecurityDepositCurrency(req.SecurityDepositCurrency)
	}
	if len(req.RentSchedule) > 0 {
		builder.SetRentSchedule(req.RentSchedule)
	}
	if len(req.RecurringCharges) > 0 {
		builder.SetRecurringCharges(req.RecurringCharges)
	}
	if req.LateFeePolicy != nil {
		builder.SetLateFeePolicy(req.LateFeePolicy)
	}
	if req.CamTerms != nil {
		builder.SetCamTerms(req.CamTerms)
	}
	if req.TenantImprovement != nil {
		builder.SetTenantImprovement(req.TenantImprovement)
	}
	if len(req.RenewalOptions) > 0 {
		builder.SetRenewalOptions(req.RenewalOptions)
	}
	if len(req.UsageCharges) > 0 {
		builder.SetUsageCharges(req.UsageCharges)
	}
	if req.PercentageRent != nil {
		builder.SetPercentageRent(req.PercentageRent)
	}
	if len(req.ExpansionRights) > 0 {
		builder.SetExpansionRights(req.ExpansionRights)
	}
	if len(req.ContractionRights) > 0 {
		builder.SetContractionRights(req.ContractionRights)
	}
	if req.Subsidy != nil {
		builder.SetSubsidy(req.Subsidy)
	}
	if req.MoveInDate != nil {
		builder.SetNillableMoveInDate(req.MoveInDate)
	}
	if req.MoveOutDate != nil {
		builder.SetNillableMoveOutDate(req.MoveOutDate)
	}
	if req.NoticeDate != nil {
		builder.SetNillableNoticeDate(req.NoticeDate)
	}
	builder.SetNoticeRequiredDays(req.NoticeRequiredDays)
	if req.CheckInTime != nil {
		builder.SetNillableCheckInTime(req.CheckInTime)
	}
	if req.CheckOutTime != nil {
		builder.SetNillableCheckOutTime(req.CheckOutTime)
	}
	if req.CleaningFeeAmountCents != nil {
		builder.SetNillableCleaningFeeAmountCents(req.CleaningFeeAmountCents)
	}
	if req.CleaningFeeCurrency != nil {
		builder.SetNillableCleaningFeeCurrency(req.CleaningFeeCurrency)
	}
	if req.PlatformBookingID != nil {
		builder.SetNillablePlatformBookingID(req.PlatformBookingID)
	}
	if req.MembershipTier != nil {
		builder.SetMembershipTier(lease.MembershipTier(*req.MembershipTier))
	}
	builder.SetIsSublease(req.IsSublease)
	if req.SubleaseBilling != "" {
		builder.SetSubleaseBilling(lease.SubleaseBilling(req.SubleaseBilling))
	}
	if req.SigningMethod != nil {
		builder.SetSigningMethod(lease.SigningMethod(*req.SigningMethod))
	}
	if req.SignedAt != nil {
		builder.SetNillableSignedAt(req.SignedAt)
	}
	if req.DocumentID != nil {
		builder.SetNillableDocumentID(req.DocumentID)
	}
	if req.ParentLeaseID != nil {
		uid, err := uuid.Parse(*req.ParentLeaseID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid parent_lease_id")
			return
		}
		builder.SetParentLeaseID(uid)
	}
	builder.SetCreatedBy(audit.Actor).SetUpdatedBy(audit.Actor).SetSource(lease.Source(audit.Source))
	if audit.CorrelationID != nil {
		builder.SetCorrelationID(*audit.CorrelationID)
	}
	result, err := builder.Save(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusCreated, result)
}

func (h *LeaseHandler) GetLease(w http.ResponseWriter, r *http.Request) {
	id, ok := parseUUID(w, r, "id")
	if !ok {
		return
	}
	result, err := h.client.Lease.Get(r.Context(), id)
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, result)
}

func (h *LeaseHandler) ListLeases(w http.ResponseWriter, r *http.Request) {
	pg := parsePagination(r)
	items, err := h.client.Lease.Query().
		Limit(pg.Limit).Offset(pg.Offset).
		Order(ent.Desc(lease.FieldCreatedAt)).
		All(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, items)
}

type updateLeaseRequest struct {
	PropertyID                 *string                   `json:"property_id,omitempty"`
	TenantRoleIds              []string                  `json:"tenant_role_ids,omitempty"`
	GuarantorRoleIds           []string                  `json:"guarantor_role_ids,omitempty"`
	LeaseType                  *string                   `json:"lease_type,omitempty"`
	Status                     *string                   `json:"status,omitempty"`
	Description                *string                   `json:"description,omitempty"`
	LiabilityType              *string                   `json:"liability_type,omitempty"`
	Term                       *types.DateRange          `json:"term,omitempty"`
	LeaseCommencementDate      *time.Time                `json:"lease_commencement_date,omitempty"`
	RentCommencementDate       *time.Time                `json:"rent_commencement_date,omitempty"`
	BaseRentAmountCents        *int64                    `json:"base_rent_amount_cents,omitempty"`
	BaseRentCurrency           *string                   `json:"base_rent_currency,omitempty"`
	SecurityDepositAmountCents *int64                    `json:"security_deposit_amount_cents,omitempty"`
	SecurityDepositCurrency    *string                   `json:"security_deposit_currency,omitempty"`
	RentSchedule               []types.RentScheduleEntry `json:"rent_schedule,omitempty"`
	RecurringCharges           []types.RecurringCharge   `json:"recurring_charges,omitempty"`
	LateFeePolicy              *types.LateFeePolicy      `json:"late_fee_policy,omitempty"`
	CamTerms                   *types.CAMTerms           `json:"cam_terms,omitempty"`
	TenantImprovement          *types.TenantImprovement  `json:"tenant_improvement,omitempty"`
	RenewalOptions             []types.RenewalOption     `json:"renewal_options,omitempty"`
	UsageCharges               []types.UsageBasedCharge  `json:"usage_charges,omitempty"`
	PercentageRent             *types.PercentageRent     `json:"percentage_rent,omitempty"`
	ExpansionRights            []types.ExpansionRight    `json:"expansion_rights,omitempty"`
	ContractionRights          []types.ContractionRight  `json:"contraction_rights,omitempty"`
	Subsidy                    *types.SubsidyTerms       `json:"subsidy,omitempty"`
	MoveInDate                 *time.Time                `json:"move_in_date,omitempty"`
	MoveOutDate                *time.Time                `json:"move_out_date,omitempty"`
	NoticeDate                 *time.Time                `json:"notice_date,omitempty"`
	NoticeRequiredDays         *int                      `json:"notice_required_days,omitempty"`
	CheckInTime                *string                   `json:"check_in_time,omitempty"`
	CheckOutTime               *string                   `json:"check_out_time,omitempty"`
	CleaningFeeAmountCents     *int64                    `json:"cleaning_fee_amount_cents,omitempty"`
	CleaningFeeCurrency        *string                   `json:"cleaning_fee_currency,omitempty"`
	PlatformBookingID          *string                   `json:"platform_booking_id,omitempty"`
	MembershipTier             *string                   `json:"membership_tier,omitempty"`
	IsSublease                 *bool                     `json:"is_sublease,omitempty"`
	SubleaseBilling            *string                   `json:"sublease_billing,omitempty"`
	SigningMethod              *string                   `json:"signing_method,omitempty"`
	SignedAt                   *time.Time                `json:"signed_at,omitempty"`
	DocumentID                 *string                   `json:"document_id,omitempty"`
	ParentLeaseID              *string                   `json:"parent_lease_id,omitempty"`
}

func (h *LeaseHandler) UpdateLease(w http.ResponseWriter, r *http.Request) {
	id, ok := parseUUID(w, r, "id")
	if !ok {
		return
	}
	audit, ok := parseAuditContext(w, r)
	if !ok {
		return
	}
	var req updateLeaseRequest
	if err := decodeJSON(r, &req); err != nil {
		writeError(w, http.StatusBadRequest, "INVALID_JSON", err.Error())
		return
	}
	builder := h.client.Lease.UpdateOneID(id)
	if req.PropertyID != nil {
		builder.SetPropertyID(*req.PropertyID)
	}
	if req.TenantRoleIds != nil {
		builder.SetTenantRoleIds(req.TenantRoleIds)
	}
	if req.GuarantorRoleIds != nil {
		builder.SetGuarantorRoleIds(req.GuarantorRoleIds)
	}
	if req.LeaseType != nil {
		builder.SetLeaseType(lease.LeaseType(*req.LeaseType))
	}
	if req.Status != nil {
		builder.SetStatus(lease.Status(*req.Status))
	}
	if req.Description != nil {
		builder.SetNillableDescription(req.Description)
	}
	if req.LiabilityType != nil {
		builder.SetLiabilityType(lease.LiabilityType(*req.LiabilityType))
	}
	if req.Term != nil {
		builder.SetTerm(req.Term)
	}
	if req.LeaseCommencementDate != nil {
		builder.SetNillableLeaseCommencementDate(req.LeaseCommencementDate)
	}
	if req.RentCommencementDate != nil {
		builder.SetNillableRentCommencementDate(req.RentCommencementDate)
	}
	if req.BaseRentAmountCents != nil {
		builder.SetBaseRentAmountCents(*req.BaseRentAmountCents)
	}
	if req.BaseRentCurrency != nil {
		builder.SetBaseRentCurrency(*req.BaseRentCurrency)
	}
	if req.SecurityDepositAmountCents != nil {
		builder.SetSecurityDepositAmountCents(*req.SecurityDepositAmountCents)
	}
	if req.SecurityDepositCurrency != nil {
		builder.SetSecurityDepositCurrency(*req.SecurityDepositCurrency)
	}
	if req.RentSchedule != nil {
		builder.SetRentSchedule(req.RentSchedule)
	}
	if req.RecurringCharges != nil {
		builder.SetRecurringCharges(req.RecurringCharges)
	}
	if req.LateFeePolicy != nil {
		builder.SetLateFeePolicy(req.LateFeePolicy)
	}
	if req.CamTerms != nil {
		builder.SetCamTerms(req.CamTerms)
	}
	if req.TenantImprovement != nil {
		builder.SetTenantImprovement(req.TenantImprovement)
	}
	if req.RenewalOptions != nil {
		builder.SetRenewalOptions(req.RenewalOptions)
	}
	if req.UsageCharges != nil {
		builder.SetUsageCharges(req.UsageCharges)
	}
	if req.PercentageRent != nil {
		builder.SetPercentageRent(req.PercentageRent)
	}
	if req.ExpansionRights != nil {
		builder.SetExpansionRights(req.ExpansionRights)
	}
	if req.ContractionRights != nil {
		builder.SetContractionRights(req.ContractionRights)
	}
	if req.Subsidy != nil {
		builder.SetSubsidy(req.Subsidy)
	}
	if req.MoveInDate != nil {
		builder.SetNillableMoveInDate(req.MoveInDate)
	}
	if req.MoveOutDate != nil {
		builder.SetNillableMoveOutDate(req.MoveOutDate)
	}
	if req.NoticeDate != nil {
		builder.SetNillableNoticeDate(req.NoticeDate)
	}
	if req.NoticeRequiredDays != nil {
		builder.SetNoticeRequiredDays(*req.NoticeRequiredDays)
	}
	if req.CheckInTime != nil {
		builder.SetNillableCheckInTime(req.CheckInTime)
	}
	if req.CheckOutTime != nil {
		builder.SetNillableCheckOutTime(req.CheckOutTime)
	}
	if req.CleaningFeeAmountCents != nil {
		builder.SetCleaningFeeAmountCents(*req.CleaningFeeAmountCents)
	}
	if req.CleaningFeeCurrency != nil {
		builder.SetCleaningFeeCurrency(*req.CleaningFeeCurrency)
	}
	if req.PlatformBookingID != nil {
		builder.SetNillablePlatformBookingID(req.PlatformBookingID)
	}
	if req.MembershipTier != nil {
		builder.SetMembershipTier(lease.MembershipTier(*req.MembershipTier))
	}
	if req.IsSublease != nil {
		builder.SetIsSublease(*req.IsSublease)
	}
	if req.SubleaseBilling != nil {
		builder.SetSubleaseBilling(lease.SubleaseBilling(*req.SubleaseBilling))
	}
	if req.SigningMethod != nil {
		builder.SetSigningMethod(lease.SigningMethod(*req.SigningMethod))
	}
	if req.SignedAt != nil {
		builder.SetNillableSignedAt(req.SignedAt)
	}
	if req.DocumentID != nil {
		builder.SetNillableDocumentID(req.DocumentID)
	}
	if req.ParentLeaseID != nil {
		uid, err := uuid.Parse(*req.ParentLeaseID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid parent_lease_id")
			return
		}
		builder.SetParentLeaseID(uid)
	}
	builder.SetUpdatedBy(audit.Actor).SetSource(lease.Source(audit.Source))
	if audit.CorrelationID != nil {
		builder.SetCorrelationID(*audit.CorrelationID)
	}
	result, err := builder.Save(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, result)
}

func (h *LeaseHandler) transitionLease(w http.ResponseWriter, r *http.Request, targetStatus string, applyExtra func(*ent.LeaseUpdateOne)) {
	id, ok := parseUUID(w, r, "id")
	if !ok {
		return
	}
	audit, ok := parseAuditContext(w, r)
	if !ok {
		return
	}
	current, err := h.client.Lease.Get(r.Context(), id)
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	if err := ValidateTransition(schema.ValidLeaseTransitions, string(current.Status), targetStatus); err != nil {
		writeError(w, http.StatusConflict, "INVALID_TRANSITION", err.Error())
		return
	}
	builder := h.client.Lease.UpdateOneID(id).
		SetStatus(lease.Status(targetStatus)).
		SetUpdatedBy(audit.Actor).
		SetSource(lease.Source(audit.Source))
	if audit.CorrelationID != nil {
		builder.SetCorrelationID(*audit.CorrelationID)
	}
	if applyExtra != nil {
		applyExtra(builder)
	}
	updated, err := builder.Save(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, updated)
}

func (h *LeaseHandler) SubmitForApproval(w http.ResponseWriter, r *http.Request) {
	h.transitionLease(w, r, "pending_approval", nil)
}

func (h *LeaseHandler) ApproveLease(w http.ResponseWriter, r *http.Request) {
	h.transitionLease(w, r, "pending_signature", nil)
}

func (h *LeaseHandler) ActivateLease(w http.ResponseWriter, r *http.Request) {
	type extraFields struct {
		MoveInDate *time.Time `json:"move_in_date,omitempty"`
	}
	var extra extraFields
	_ = decodeJSON(r, &extra)
	h.transitionLease(w, r, "active", func(b *ent.LeaseUpdateOne) {
		if extra.MoveInDate != nil {
			b.SetNillableMoveInDate(extra.MoveInDate)
		}
	})
}

func (h *LeaseHandler) TerminateLease(w http.ResponseWriter, r *http.Request) {
	type extraFields struct {
		Reason      string     `json:"reason,omitempty"`
		MoveOutDate *time.Time `json:"move_out_date,omitempty"`
	}
	var extra extraFields
	_ = decodeJSON(r, &extra)
	h.transitionLease(w, r, "terminated", func(b *ent.LeaseUpdateOne) {
		if extra.MoveOutDate != nil {
			b.SetNillableMoveOutDate(extra.MoveOutDate)
		}
	})
}

func (h *LeaseHandler) RenewLease(w http.ResponseWriter, r *http.Request) {
	h.transitionLease(w, r, "renewed", nil)
}

func (h *LeaseHandler) InitiateEviction(w http.ResponseWriter, r *http.Request) {
	h.transitionLease(w, r, "eviction", nil)
}

// ============================================================================
// LeaseSpace
// ============================================================================

type createLeaseSpaceRequest struct {
	IsPrimary           bool            `json:"is_primary"`
	Relationship        string          `json:"relationship"`
	Effective           types.DateRange `json:"effective"`
	SquareFootageLeased *float64        `json:"square_footage_leased,omitempty"`
	LeaseID             string          `json:"lease_id"`
	SpaceID             string          `json:"space_id"`
}

func (h *LeaseHandler) CreateLeaseSpace(w http.ResponseWriter, r *http.Request) {
	audit, ok := parseAuditContext(w, r)
	if !ok {
		return
	}
	var req createLeaseSpaceRequest
	if err := decodeJSON(r, &req); err != nil {
		writeError(w, http.StatusBadRequest, "INVALID_JSON", err.Error())
		return
	}
	builder := h.client.LeaseSpace.Create()
	builder.SetIsPrimary(req.IsPrimary)
	builder.SetRelationship(leasespace.Relationship(req.Relationship))
	builder.SetEffective(&req.Effective)
	if req.SquareFootageLeased != nil {
		builder.SetNillableSquareFootageLeased(req.SquareFootageLeased)
	}
	{
		uid, err := uuid.Parse(req.LeaseID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid lease_id")
			return
		}
		builder.SetLeaseID(uid)
	}
	{
		uid, err := uuid.Parse(req.SpaceID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid space_id")
			return
		}
		builder.SetSpaceID(uid)
	}
	builder.SetCreatedBy(audit.Actor).SetUpdatedBy(audit.Actor).SetSource(leasespace.Source(audit.Source))
	if audit.CorrelationID != nil {
		builder.SetCorrelationID(*audit.CorrelationID)
	}
	result, err := builder.Save(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusCreated, result)
}

func (h *LeaseHandler) GetLeaseSpace(w http.ResponseWriter, r *http.Request) {
	id, ok := parseUUID(w, r, "id")
	if !ok {
		return
	}
	result, err := h.client.LeaseSpace.Get(r.Context(), id)
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, result)
}

func (h *LeaseHandler) ListLeaseSpaces(w http.ResponseWriter, r *http.Request) {
	pg := parsePagination(r)
	items, err := h.client.LeaseSpace.Query().
		Limit(pg.Limit).Offset(pg.Offset).
		Order(ent.Desc(leasespace.FieldCreatedAt)).
		All(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, items)
}

type updateLeaseSpaceRequest struct {
	IsPrimary           *bool            `json:"is_primary,omitempty"`
	Relationship        *string          `json:"relationship,omitempty"`
	Effective           *types.DateRange `json:"effective,omitempty"`
	SquareFootageLeased *float64         `json:"square_footage_leased,omitempty"`
	LeaseID             *string          `json:"lease_id,omitempty"`
	SpaceID             *string          `json:"space_id,omitempty"`
}

func (h *LeaseHandler) UpdateLeaseSpace(w http.ResponseWriter, r *http.Request) {
	id, ok := parseUUID(w, r, "id")
	if !ok {
		return
	}
	audit, ok := parseAuditContext(w, r)
	if !ok {
		return
	}
	var req updateLeaseSpaceRequest
	if err := decodeJSON(r, &req); err != nil {
		writeError(w, http.StatusBadRequest, "INVALID_JSON", err.Error())
		return
	}
	builder := h.client.LeaseSpace.UpdateOneID(id)
	if req.IsPrimary != nil {
		builder.SetIsPrimary(*req.IsPrimary)
	}
	if req.Relationship != nil {
		builder.SetRelationship(leasespace.Relationship(*req.Relationship))
	}
	if req.Effective != nil {
		builder.SetEffective(req.Effective)
	}
	if req.SquareFootageLeased != nil {
		builder.SetNillableSquareFootageLeased(req.SquareFootageLeased)
	}
	if req.LeaseID != nil {
		uid, err := uuid.Parse(*req.LeaseID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid lease_id")
			return
		}
		builder.SetLeaseID(uid)
	}
	if req.SpaceID != nil {
		uid, err := uuid.Parse(*req.SpaceID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid space_id")
			return
		}
		builder.SetSpaceID(uid)
	}
	builder.SetUpdatedBy(audit.Actor).SetSource(leasespace.Source(audit.Source))
	if audit.CorrelationID != nil {
		builder.SetCorrelationID(*audit.CorrelationID)
	}
	result, err := builder.Save(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, result)
}

// ============================================================================
// Application
// ============================================================================

type createApplicationRequest struct {
	Status                    string     `json:"status"`
	DesiredMoveIn             time.Time  `json:"desired_move_in"`
	DesiredLeaseTermMonths    int        `json:"desired_lease_term_months"`
	ScreeningRequestID        *string    `json:"screening_request_id,omitempty"`
	ScreeningCompleted        *time.Time `json:"screening_completed,omitempty"`
	CreditScore               *int       `json:"credit_score,omitempty"`
	BackgroundClear           bool       `json:"background_clear"`
	IncomeVerified            bool       `json:"income_verified"`
	IncomeToRentRatio         *float64   `json:"income_to_rent_ratio,omitempty"`
	DecisionBy                *string    `json:"decision_by,omitempty"`
	DecisionAt                *time.Time `json:"decision_at,omitempty"`
	DecisionReason            *string    `json:"decision_reason,omitempty"`
	Conditions                []string   `json:"conditions,omitempty"`
	ApplicationFeeAmountCents int64      `json:"application_fee_amount_cents"`
	ApplicationFeeCurrency    string     `json:"application_fee_currency,omitempty"`
	FeePaid                   bool       `json:"fee_paid"`
	PropertyID                string     `json:"property_id"`
	SpaceID                   *string    `json:"space_id,omitempty"`
	ApplicantPersonID         string     `json:"applicant_person_id"`
}

func (h *LeaseHandler) CreateApplication(w http.ResponseWriter, r *http.Request) {
	audit, ok := parseAuditContext(w, r)
	if !ok {
		return
	}
	var req createApplicationRequest
	if err := decodeJSON(r, &req); err != nil {
		writeError(w, http.StatusBadRequest, "INVALID_JSON", err.Error())
		return
	}
	builder := h.client.Application.Create()
	builder.SetStatus(application.Status(req.Status))
	builder.SetDesiredMoveIn(req.DesiredMoveIn)
	builder.SetDesiredLeaseTermMonths(req.DesiredLeaseTermMonths)
	if req.ScreeningRequestID != nil {
		builder.SetNillableScreeningRequestID(req.ScreeningRequestID)
	}
	if req.ScreeningCompleted != nil {
		builder.SetNillableScreeningCompleted(req.ScreeningCompleted)
	}
	if req.CreditScore != nil {
		builder.SetNillableCreditScore(req.CreditScore)
	}
	builder.SetBackgroundClear(req.BackgroundClear)
	builder.SetIncomeVerified(req.IncomeVerified)
	if req.IncomeToRentRatio != nil {
		builder.SetNillableIncomeToRentRatio(req.IncomeToRentRatio)
	}
	if req.DecisionBy != nil {
		builder.SetNillableDecisionBy(req.DecisionBy)
	}
	if req.DecisionAt != nil {
		builder.SetNillableDecisionAt(req.DecisionAt)
	}
	if req.DecisionReason != nil {
		builder.SetNillableDecisionReason(req.DecisionReason)
	}
	if len(req.Conditions) > 0 {
		builder.SetConditions(req.Conditions)
	}
	builder.SetApplicationFeeAmountCents(req.ApplicationFeeAmountCents)
	if req.ApplicationFeeCurrency != "" {
		builder.SetApplicationFeeCurrency(req.ApplicationFeeCurrency)
	}
	builder.SetFeePaid(req.FeePaid)
	{
		uid, err := uuid.Parse(req.PropertyID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid property_id")
			return
		}
		builder.SetPropertyID(uid)
	}
	if req.SpaceID != nil {
		uid, err := uuid.Parse(*req.SpaceID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid space_id")
			return
		}
		builder.SetSpaceID(uid)
	}
	{
		uid, err := uuid.Parse(req.ApplicantPersonID)
		if err != nil {
			writeError(w, http.StatusBadRequest, "INVALID_ID", "invalid applicant_person_id")
			return
		}
		builder.SetApplicantID(uid)
	}
	builder.SetCreatedBy(audit.Actor).SetUpdatedBy(audit.Actor).SetSource(application.Source(audit.Source))
	if audit.CorrelationID != nil {
		builder.SetCorrelationID(*audit.CorrelationID)
	}
	result, err := builder.Save(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusCreated, result)
}

func (h *LeaseHandler) GetApplication(w http.ResponseWriter, r *http.Request) {
	id, ok := parseUUID(w, r, "id")
	if !ok {
		return
	}
	result, err := h.client.Application.Get(r.Context(), id)
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, result)
}

func (h *LeaseHandler) ListApplications(w http.ResponseWriter, r *http.Request) {
	pg := parsePagination(r)
	items, err := h.client.Application.Query().
		Limit(pg.Limit).Offset(pg.Offset).
		Order(ent.Desc(application.FieldCreatedAt)).
		All(r.Context())
	if err != nil {
		entErrorToHTTP(w, err)
		return
	}
	writeJSON(w, http.StatusOK, items)
}
