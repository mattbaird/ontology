# Ontology Generation Audit

You are auditing a codebase that claims to generate code from a CUE ontology. The architectural principle is: "no hand-written type that represents a domain entity." The CUE ontology should be the single source of truth, and the Ent schemas, API types, event schemas, and validation logic should be generated from it.

## Test 1: The Rename Test

Rename `base_rent` to `monthly_rent` in the CUE ontology file ONLY. Do NOT touch any other file. Then run `make generate` (or whatever the codegen command is).

If the system is properly generated:
- The Ent schema should now have `monthly_rent_cents` and `monthly_rent_currency`
- The proto/API types should now have `monthly_rent`
- The database migration should rename the columns
- The agent tool definition should reference `monthly_rent`

If you have to manually update Ent schemas, proto files, handler code, or tool definitions after changing the CUE file, list every file you had to touch. That's the generation gap.

Report: How many files changed automatically vs how many required manual updates?

## Test 2: The Add-a-Field Test

Add a new field to the Lease entity in the CUE ontology:

```cue
pet_deposit: #NonNegativeMoney
```

Run the codegen. Check:
- [ ] Does the Ent schema now have `pet_deposit_cents` and `pet_deposit_currency` fields?
- [ ] Does the proto message have a `pet_deposit` field of type `Money`?
- [ ] Does the API handler's `toEnt`/`toProto` mapping function include the new field?
- [ ] Does the OpenAPI spec include the new field?
- [ ] Does the agent tool definition include it?
- [ ] Does the database migration add the columns?

For each "no" â€” that's a place where the ontology is NOT projecting into the codebase. The field was hand-coded, not generated.

## Test 3: The Constraint Test

Add this constraint to the CUE ontology:

```cue
#Lease: {
    // ... existing fields ...
    
    // NEW CONSTRAINT: Security deposit cannot exceed 2x base rent
    if security_deposit != _|_ && base_rent != _|_ {
        security_deposit: amount_cents: <= (base_rent.amount_cents * 2)
    }
}
```

Run the codegen. Check:
- [ ] Does an Ent validation hook now enforce this constraint?
- [ ] Does the API return a clear error when you try to create a lease with a $5000 deposit on a $2000/month rent?
- [ ] Or did the constraint stay trapped in the CUE file with no runtime enforcement?

If no runtime enforcement was generated, the CUE ontology is documentation, not infrastructure.

## Test 4: The State Machine Test

Add a new status value to the Lease state machine in CUE:

```cue
#LeaseTransitions: {
    // ... existing transitions ...
    pending_renewal: ["active", "terminated"]  // NEW STATE
}
```

And add `"pending_renewal"` to the Lease status enum.

Run the codegen. Check:
- [ ] Does the Ent schema's status enum now include `pending_renewal`?
- [ ] Does the state machine hook accept transitions to/from `pending_renewal`?
- [ ] Does the proto enum include the new value?
- [ ] Does the agent tool's status enum include it?

If you had to manually add `pending_renewal` to the Ent schema, the state machine is not projecting from the ontology.

## Test 5: The Provenance Test

Pick any Ent schema file (e.g., `lease.go` in `ent/schema/`). Check the top of the file:
- Does it say "Code generated by entgen from CUE ontology. DO NOT EDIT."?
- Or does it look hand-written with no generation markers?

Pick any proto service file. Same check.

Pick the agent tool definitions JSON. Same check.

If files that should be generated don't have generation markers, they were probably hand-written.

## Test 6: The Diff Test

Run this:
```bash
# Regenerate everything
make generate

# Check if anything changed
git diff --stat
```

If the diff is empty, generated code matches the ontology. If there are diffs, either:
- Someone hand-edited a generated file (ontological drift), or
- The codegen was never set up to produce these files

List every file that shows a diff and explain whether it's drift or a missing generation target.

## Summary Report

After running all 6 tests, fill in this table:

| Artifact | Fully Generated? | Partially Generated? | Hand-Written? |
|----------|-----------------|---------------------|---------------|
| Ent schema fields | | | |
| Ent schema edges | | | |
| Ent state machine hooks | | | |
| Ent validation hooks | | | |
| Ent privacy policies | | | |
| Proto message types | | | |
| Proto service definitions | | | |
| Connect handler signatures | | | |
| Connect handler auth checks | | | |
| Connect handler business logic | | | |
| toEnt/toProto mapping functions | | | |
| OpenAPI spec | | | |
| Agent tool definitions | | | |
| Event schemas | | | |
| Database migrations | | | |

For anything marked "Hand-Written" that SHOULD be generated based on the architecture spec, explain what's missing in the codegen pipeline and what it would take to fix it.